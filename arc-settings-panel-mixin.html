<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/lib/utils/mixin.html">
<script>
(function(global) {
'use strict';
if (!global.ArcComponents) {
  /**
   * @namespace ArcComponents
   */
  global.ArcComponents = {};
}
/**
 * Components implementing this mixin are part of ARC settings panel.
 * After mixing it into the prototype the component gain access to common
 * methods to read and update application settings.
 *
 * The element should override two methods: `_processValues()` and
 * `_setSettings()`. Process values shouls process incomming data and set
 * defaults and proper data types (application storage may not respect data
 * types!). When this function is not provided the element will use data as they
 * arrive from settings provider. The `_setSettings()` function should be used
 * to set appropieate settings on the UI.
 *
 * @polymer
 * @mixinFunction
 * @memberof ArcComponents
 */
global.ArcComponents.ArcSettingsPanelMixin = Polymer.dedupingMixin((base) => {
  /**
   * @polymer
   * @mixinClass
   */
  class ASPmixin extends base {
    static get properties() {
      return {
        /**
         * When set the element will not request current settings state and
         * will wait until it's properties are set.
         */
        manual: Boolean,
        /**
         * When set the settings are baing loaded.
         */
        loading: {type: Boolean, readOnly: true, notify: true},
        /**
         * Some panels have sub pages. This tracks selected page.
         */
        page: Number
      };
    }

    connectedCallback() {
      super.connectedCallback();
      if (!this.manual) {
        this.loadSettings();
      }
    }
    /**
     * Dispatches `settings-read` custom event to settings provider to read
     * application settings and sets received values on the component.
     *
     * @return {Promise} Promise resolved when operartion ends.
     */
    loadSettings() {
      this._setLoading(true);
      return this._readSettings()
      .then((settings) => this._setSettings(settings))
      .catch((cause) => {
        console.error(cause);
        throw cause;
      });
    }

    _readSettings() {
      const e = new CustomEvent('settings-read', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {}
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject('Settings provided not found.');
      }
      return e.detail.result
      .then((settings) => this._processValues(settings));
    }

    _processValues(values) {
      return values;
    }

    _setSettings() {}
    /**
     * Dispatches `settings-changed` to settings provider with new value.
     *
     * @param {String} key Setting key
     * @param {any} value Value to store. Values are serialized.
     * @return {Promise} Promise resolved when settings are stored.
     */
    updateSetting(key, value) {
      const e = new CustomEvent('settings-changed', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          name: key,
          value
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject('Settings provided not found.');
      }
      return e.detail.result;
    }
    /**
     * Returns a boolean value for the `value`.
     * @param {any} value
     * @return {Boolean}
     */
    _boolValue(value) {
      const type = typeof value;
      if (type === 'boolean') {
        return value;
      }
      if (type === 'string') {
        return type === 'true' ? true : false;
      }
      return !!value;
    }
    /**
     *  Returns a numeric value for the `value`
     * @param {any} val Current value
     * @return {Number} Translated value
     */
    _numValue(val) {
      val = Number(val);
      if (val !== val) {
        return 0;
      }
      return val;
    }
    /**
     * Shows internal sub-page
     *
     * @param {ClickEvent} e
     */
    _showPage(e) {
      const path = e.composedPath();
      let target;
      while (true) {
        const item = path.shift();
        if (!item) {
          return;
        }
        if (item.dataset && item.dataset.page) {
          target = item;
          break;
        }
      }
      const page = Number(target.dataset.page);
      if (page === page) {
        this.page = page;
      }
    }
    /**
     * Restores the main page of the editor.
     */
    back() {
      this.page = 0;
    }
    /**
     * To be used when a list item has a toggle button.
     * When clicking on the list option this function should be called to
     * toggle the button.
     * @param {ClickEvent} e
     */
    _toggleOption(e) {
      const button = e.currentTarget.querySelector('paper-toggle-button');
      button.checked = !button.checked;
    }
    /**
     * Cancels the event and it's propagation.
     * @param {Event} e
     */
    _cancelEvent(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    /**
     * Opens a URL in new window.
     * If the application handle `open-external-url` then it does nothing.
     *
     * @param {String} url
     */
    _openLink(url) {
      const e = new CustomEvent('open-external-url', {
        bubbles: true,
        cancelable: true,
        composed: true,
        detail: {
          url
        }
      });
      this.dispatchEvent(e);
      if (e.defaultPrevented) {
        return;
      }
      window.open(this.privacyPolicyUrl);
    }
  }
  return ASPmixin;
});
})(window);
</script>
</dom-module>
